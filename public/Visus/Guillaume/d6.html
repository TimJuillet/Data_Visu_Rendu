<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Donut Chart with Search</title>
    <script src="https://d3js.org/d3.v5.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <style>
        #my_dataviz {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
        #search-container {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            background-color: #f9f9f9;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="search-container">
        <input type="text" id="yearInput" placeholder="Entrez une année">
        <select id="musicStyle">
            <option value="">Choisissez un style</option>
            <option value="Rock">Rock</option>
            <option value="Pop">Pop</option>
            <option value="Jazz">Jazz</option>
            <option value="Hip-Hop">Hip-Hop</option>
            <option value="Classical">Classique</option>
        </select>
        <input type="text" id="countryInput" placeholder="Entrez un pays">
        <button id="searchButton">Rechercher</button>
    </div>

    <div id="my_dataviz"></div>

    <script>
        // Adapter les dimensions du graphique en fonction de la fenêtre
        var width = window.innerWidth,
            height = window.innerHeight,
            margin = 40;

        var radius = Math.min(width, height) / 2 - margin;

        var svg = d3.select("#my_dataviz")
          .append("svg")
            .attr("width", width)
            .attr("height", height)
          .append("g")
            .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

        var color = d3.scaleOrdinal(d3.schemeCategory10);

        // Fonction pour dessiner le graphique donut
        function drawDonut(data) {
            svg.selectAll("*").remove();

            // Trier les données du plus grand au plus petit
            var sortedData = d3.entries(data).sort((a, b) => b.value - a.value);

            // Grouper les secteurs de moins de 5 % dans une catégorie "Autre"
            var totalValue = d3.sum(sortedData, d => d.value);
            var processedData = sortedData.reduce((acc, d) => {
                if ((d.value / totalValue) * 100 < 2) {
                    acc["Autre"] = (acc["Autre"] || 0) + d.value;
                } else {
                    acc[d.key] = d.value;
                }
                return acc;
            }, {});

            var pie = d3.pie()
                .sort(null)
                .value(d => d.value);

            var data_ready = pie(d3.entries(processedData));

            var arc = d3.arc()
                .innerRadius(radius * 0.5)
                .outerRadius(radius * 0.8);

            var outerArc = d3.arc()
                .innerRadius(radius * 0.9)
                .outerRadius(radius * 0.9);

            // Ajouter les secteurs du donut
            svg.selectAll('allSlices')
                .data(data_ready)
                .enter()
                .append('path')
                .attr('d', arc)
                .attr('fill', function(d){ return(color(d.data.key)) })
                .attr("stroke", "white")
                .style("stroke-width", "2px")
                .style("opacity", 0.7);

            // Ajouter les polylines entre le diagramme et les labels
            svg.selectAll('allPolylines')
                .data(data_ready)
                .enter()
                .append('polyline')
                .attr("stroke", "black")
                .style("fill", "none")
                .attr("stroke-width", 1)
                .attr('points', function(d) {
                    var posA = arc.centroid(d); // Point d'insertion dans le secteur
                    var posB = outerArc.centroid(d); // Point de rupture de la ligne
                    var posC = outerArc.centroid(d); // Position du label
                    var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -1); // Positionner à gauche ou à droite
                    return [posA, posB, posC];
                });

            // Ajouter les labels et les positionner à l'extrémité de chaque ligne
            svg.selectAll('allLabels')
                .data(data_ready)
                .enter()
                .append('text')
                .text(function(d) { return d.data.key; })
                .attr('transform', function(d) {
                    var pos = outerArc.centroid(d);
                    var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
                    return 'translate(' + pos + ')';
                })
                .style('text-anchor', function(d) {
                    var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2;
                    return (midangle < Math.PI ? 'start' : 'end');
                });
        }

        // Fonction pour mettre à jour les données du graphique
        function updateChart(year, genre, country) {
            d3.json("..\\..\\data\\Guillaume2.json").then(function(data) {
                if (data[country] && data[country][genre] && data[country][genre][year]) {
                    var genreData = data[country][genre][year][1];
                    var subGenreData = {};
                    for (var subGenre in genreData) {
                        subGenreData[subGenre] = genreData[subGenre][0];
                    }
                    console.log("Données trouvées pour les critères sélectionnés.", subGenreData);
                    drawDonut(subGenreData);
                } else {
                    console.log("Aucune donnée trouvée pour les critères sélectionnés.");
                    alert("Aucune donnée trouvée pour les critères sélectionnés.");
                }
            });
        }

        // Event listener pour le bouton de recherche
        document.getElementById('searchButton').addEventListener('click', function() {
            var year = document.getElementById('yearInput').value;
            var genre = document.getElementById('musicStyle').value;
            var country = document.getElementById('countryInput').value;

            if (year && genre && country) {
                updateChart(year, genre, country);
            } else {
                alert("Veuillez remplir tous les champs.");
            }
        });
    </script>
</body>
</html>
